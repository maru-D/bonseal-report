<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bonseal Racing 2025 积分报表</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      color: #212529;
      font-family: "Helvetica Neue", sans-serif;
      font-size: 0.9rem;
    }
    h2, h3 {
      color: #0d6efd;
      margin-top: 20px;
    }
    .table thead {
      background-color: #0d6efd;
      color: #fff;
    }
    .card {
      background-color: #ffffff;
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 20px;
    }
    table {
      color: #212529;
    }
    canvas {
      max-width: 100%;
      background-color: #ffffff;
      border-radius: 5px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">Bonseal Racing 2025 赛季战报</h2>

    <div class="row g-4">
      <div class="col-lg-6 col-md-12">
        <div class="card">
          <h3>赛季总积分榜</h3>
          <table class="table table-striped" id="standings"></table>
        </div>
      </div>
      <div class="col-lg-6 col-md-12">
        <div class="card">
          <h3>总积分趋势图</h3>
          <canvas id="trend"></canvas>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-4">
      <div class="col-lg-6 col-md-12">
        <div class="card">
          <h3>Elo 积分榜</h3>
          <table class="table table-striped" id="eloTable"></table>
        </div>
      </div>
      <div class="col-lg-6 col-md-12">
        <div class="card">
          <h3>Elo 积分趋势图</h3>
          <canvas id="eloTrend"></canvas>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-4" id="raceCards"></div>
  </div>

<script>
  const pointsTable = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1];
  const INITIAL_ELO = 1500;
  const K = 20;

  fetch('data.json')
    .then(response => response.json())
    .then(data => {
      let driversSet = new Set();
      let raceLabels = [];
      let totalPoints = {};
      let elo = {};
      let eloHistory = {};

      data.races.forEach(race => {
        race.results.forEach(res => {
          driversSet.add(res.driver);
        });
      });

      driversSet.forEach(driver => {
        totalPoints[driver] = [];
        elo[driver] = INITIAL_ELO;
        eloHistory[driver] = [];
      });

      data.races.forEach((race, raceIndex) => {
        raceLabels.push(race.raceName);

        let thisRacePoints = {};

        race.results.forEach(res => {
          const driver = res.driver;
          const pos = res.position;
          let pts = (pos <= 10) ? pointsTable[pos - 1] : 0;
          thisRacePoints[driver] = pts;
        });

        const flDriver = race.fastestLap;
        if (flDriver && flDriver !== '/') {
          let top10 = race.results
                          .filter(res => res.position <= 10)
                          .map(res => res.driver);

          if (top10.includes(flDriver)) {
            if (!thisRacePoints[flDriver]) {
              thisRacePoints[flDriver] = 1;
            } else {
              thisRacePoints[flDriver] += 1;
            }
          }
        }

        driversSet.forEach(driver => {
          const prev = raceIndex > 0 ? totalPoints[driver][raceIndex - 1] : 0;
          const currPts = thisRacePoints[driver] !== undefined
                          ? thisRacePoints[driver]
                          : 0;
          totalPoints[driver][raceIndex] = prev + currPts;
        });

        let results = race.results;
        for (let i = 0; i < results.length; i++) {
          for (let j = i + 1; j < results.length; j++) {
            let winner = results[i].driver;
            let loser = results[j].driver;

            let Ra = elo[winner];
            let Rb = elo[loser];

            let Ea = 1 / (1 + Math.pow(10, (Rb - Ra) / 400));
            let Eb = 1 - Ea;

            elo[winner] += K * (1 - Ea);
            elo[loser] += K * (0 - Eb);
          }
        }

        driversSet.forEach(driver => {
          const prevElo = raceIndex > 0 ? eloHistory[driver][raceIndex - 1] : INITIAL_ELO;
          const currElo = elo[driver] !== undefined ? elo[driver] : prevElo;
          eloHistory[driver][raceIndex] = Math.round(currElo);
        });

        let html = `
          <div class="col-lg-6 col-md-12">
            <div class="card">
              <h3>${race.raceName} (${race.date})</h3>
              <p><strong>最快圈：</strong> ${race.fastestLap === '/' ? '无最快圈' : race.fastestLap}</p>
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th>名次</th>
                    <th>车手</th>
                    <th>本场积分</th>
                  </tr>
                </thead>
                <tbody>
        `;

        race.results.forEach(res => {
          const driver = res.driver;
          const posText = res.position === 21 ? '退赛' : res.position;
          const pts = thisRacePoints[driver] || 0;
          html += `<tr>
            <td>${posText}</td>
            <td>${driver}</td>
            <td>${pts}</td>
          </tr>`;
        });

        html += `</tbody></table></div></div>`;

        document.getElementById('raceCards').innerHTML += html;
      });

      let latestTotals = [];
      driversSet.forEach(d => {
        let arr = totalPoints[d];
        let sum = arr && arr.length > 0 ? arr[arr.length - 1] : 0;
        latestTotals.push({ driver: d, points: sum });
      });
      latestTotals.sort((a, b) => b.points - a.points);

      let standingsHtml = `<thead><tr><th>排名</th><th>车手</th><th>积分</th></tr></thead><tbody>`;
      latestTotals.forEach((item, idx) => {
        standingsHtml += `<tr>
          <td>${idx + 1}</td>
          <td>${item.driver}</td>
          <td>${item.points}</td>
        </tr>`;
      });
      standingsHtml += "</tbody>";
      document.getElementById('standings').innerHTML = standingsHtml;

      let datasets = [];
      latestTotals.forEach(item => {
        const d = item.driver;
        datasets.push({
          label: d,
          data: totalPoints[d],
          borderWidth: 2,
          fill: false
        });
      });
      new Chart(document.getElementById('trend'), {
        type: 'line',
        data: {
          labels: raceLabels,
          datasets: datasets
        }
      });

      let eloArray = Object.entries(elo)
        .map(([driver, rating]) => ({ driver, rating: Math.round(rating) }))
        .sort((a, b) => b.rating - a.rating);

      let eloHtml = `<thead><tr><th>排名</th><th>车手</th><th>Elo积分</th></tr></thead><tbody>`;
      eloArray.forEach((item, idx) => {
        eloHtml += `<tr>
          <td>${idx + 1}</td>
          <td>${item.driver}</td>
          <td>${item.rating}</td>
        </tr>`;
      });
      eloHtml += "</tbody>";
      document.getElementById('eloTable').innerHTML = eloHtml;

      let eloDatasets = eloArray.map(item => ({
        label: item.driver,
        data: eloHistory[item.driver] || [],
        borderWidth: 2,
        fill: false,
        borderColor: getRandomColor()
      }));
      new Chart(document.getElementById('eloTrend'), {
        type: 'line',
        data: {
          labels: raceLabels,
          datasets: eloDatasets
        }
      });
    });

  function getRandomColor() {
    let letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
      color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
  }
</script>

</body>
</html>
