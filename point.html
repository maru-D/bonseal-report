<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bonseal Racing 2025 积分报表</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      color: #212529;
      font-family: 'Montserrat', sans-serif;
      font-size: 0.9rem;
    }
    h2, h3 {
      color: #ff6f00;
      margin-top: 20px;
      font-weight: 700;
    }
    .list-group-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.1rem;
      padding: 12px 15px;
      border: none;
      border-bottom: 1px solid #dee2e6;
      background-color: #fff;
    }
    .list-group-item:hover {
      background-color: #f1f3f5;
      cursor: pointer;
    }
    .driver-name {
      font-weight: 700;
      color: #212529;
    }
    .driver-points {
      font-weight: 700;
      color: #ff6f00;
      font-size: 1.2rem;
      margin-right: 10px;
    }
    .driver-elo {
      font-weight: 700;
      color: #990099;
      font-size: 1.2rem;
    }
    canvas {
      max-width: 100%;
    }
    .modal-title {
      font-weight: 700;
      color: #ff6f00;
    }
    /* 分站颜色 */
    .color-blue { color: #3366CC; }
    .color-orange { color: #FF9900; }
    .color-green { color: #109618; }
    .color-purple { color: #990099; }
    .color-red { color: #DC3912; }
    .color-cyan { color: #0099C6; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="text-center mb-4">Bonseal Racing 2025 赛季战报</h2>

    <div class="row g-4">
      <div class="col-lg-6 col-md-12">
        <h3>赛季总积分榜</h3>
        <ul class="list-group mb-4" id="standings"></ul>
      </div>
      <div class="col-lg-6 col-md-12">
        <h3 class="color-purple">实力评估榜(ELO)</h3>
        <ul class="list-group mb-4" id="eloList"></ul>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-12">
        <h3>总积分趋势图</h3>
        <canvas id="trend"></canvas>
      </div>
    </div>

    <div class="row g-4 mt-4" id="raceCards"></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="driverModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="driverModalLabel"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="driverModalBody">
          <canvas id="driverBarChart" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const pointsTable = [25, 18, 15, 12, 10, 8, 6, 4, 2, 1];
    const INITIAL_ELO = 1500;
    const K = 400;

    let driverBarChart = null;

    const colorClasses = ['color-blue', 'color-orange', 'color-green', 'color-purple', 'color-red', 'color-cyan'];

    fetch('data.json')
      .then(response => response.json())
      .then(data => {
        let driversSet = new Set();
        let raceLabels = [];
        let raceLabelsShort = [];
        let totalPoints = {};
        let stats = {};
        let racePoints = {};
        let elo = {};

        data.races.forEach(race => {
          race.results.forEach(res => {
            driversSet.add(res.driver);
          });
        });

        data.races.forEach(race => {
          raceLabels.push(race.raceName);
          raceLabelsShort.push(race.raceName.slice(0,2));
        });

        driversSet.forEach(driver => {
          totalPoints[driver] = [];
          elo[driver] = INITIAL_ELO;
          stats[driver] = {
            wins: 0,
            podiums: 0,
            dnfs: 0,
            points: 0
          };
          racePoints[driver] = [];
        });

        data.races.forEach((race, raceIndex) => {
          let thisRacePoints = {};
          let raceTotalPoints = 0;

          race.results.forEach(res => {
            const driver = res.driver;
            const pos = res.position;
            let pts = (pos <=10)? pointsTable[pos-1]:0;
            thisRacePoints[driver] = pts;
            raceTotalPoints += pts;

            if(pos===1) stats[driver].wins++;
            if(pos>=1 && pos<=3) stats[driver].podiums++;
            if(pos===21) stats[driver].dnfs++;
          });

          const flDriver = race.fastestLap;
          if(flDriver && flDriver!=='/'){
            let top10 = race.results.filter(res=>res.position<=10).map(res=>res.driver);
            if(top10.includes(flDriver)){
              thisRacePoints[flDriver]=(thisRacePoints[flDriver]||0)+1;
              raceTotalPoints +=1;
            }
          }

          // 多玩家 Elo 更新
          let eloSum = 0;
          driversSet.forEach(driver => {
            eloSum += elo[driver];
          });

          driversSet.forEach(driver => {
            if (!(driver in thisRacePoints)) {
              // 未参赛，不更新 Elo
              return;
            }
            const actualRatio = raceTotalPoints > 0
              ? (thisRacePoints[driver] || 0) / raceTotalPoints
              : 0;
            const expectedRatio = eloSum > 0
              ? elo[driver] / eloSum
              : 1 / driversSet.size;
            const delta = K * (actualRatio - expectedRatio);
            elo[driver] += delta;
          });

          driversSet.forEach(driver=>{
            const prev = raceIndex>0 ? totalPoints[driver][raceIndex-1]:0;
            const curr = thisRacePoints[driver]||0;
            totalPoints[driver][raceIndex]=prev+curr;
            racePoints[driver][raceIndex]=curr;
          });

          race.results.forEach(res=>{
            stats[res.driver].points=totalPoints[res.driver][raceIndex];
          });

          let colorClass = colorClasses[raceIndex % colorClasses.length];

          let html = `
          <div class="col-lg-6 col-md-12">
            <div class="card p-3">
              <h3 class="${colorClass}">${race.raceName} (${race.date})</h3>
              <p><strong class="${colorClass}">最快圈：</strong> ${race.fastestLap==='/'?'无最快圈':race.fastestLap}</p>
              <ul class="list-group">`;

          race.results.forEach(res=>{
            const driver = res.driver;
            const posText = res.position===21?'退赛':String(res.position);
            const pts = thisRacePoints[driver]||0;
            html+=`<li class="list-group-item">
              <div><span class="me-2">${posText.padStart(2,'0')}</span><span class="driver-name">${driver}</span></div>
              <div class="driver-points ${colorClass}">${pts} 分</div>
            </li>`;
          });

          html+=`</ul></div></div>`;
          document.getElementById('raceCards').innerHTML+=html;
        });

        let latestTotals = [];
        driversSet.forEach(d=>{
          let sum = totalPoints[d][totalPoints[d].length-1]||0;
          latestTotals.push({driver:d,points:sum, elo:Math.round(elo[d])});
        });

        // 积分榜
        let sortedByPoints = [...latestTotals].sort((a,b)=>b.points-a.points);
        let standingsHtml = "";
        sortedByPoints.forEach((item,idx)=>{
          standingsHtml+=`<li class="list-group-item" data-driver="${item.driver}">
            <div><span class="me-2">${String(idx+1).padStart(2,'0')}</span><span class="driver-name">${item.driver}</span></div>
            <div class="driver-points">${item.points} 分</div>
          </li>`;
        });
        document.getElementById('standings').innerHTML=standingsHtml;

        // Elo 榜
        let sortedByElo = [...latestTotals].sort((a,b)=>b.elo - a.elo);
        let eloHtml = "";
        sortedByElo.forEach((item,idx)=>{
          eloHtml+=`<li class="list-group-item">
            <div><span class="me-2">${String(idx+1).padStart(2,'0')}</span><span class="driver-name">${item.driver}</span></div>
            <div class="driver-elo">${item.elo}</div>
          </li>`;
        });
        document.getElementById('eloList').innerHTML = eloHtml;

        document.querySelectorAll('#standings .list-group-item').forEach(el=>{
          el.addEventListener('click',()=>{
            const driver=el.dataset.driver;
            const s=stats[driver];
            document.getElementById('driverModalLabel').innerText=driver;
            document.getElementById('driverModalBody').innerHTML=`
              <p><strong>总积分：</strong>${s.points}</p>
              <p><strong>获胜次数：</strong>${s.wins}</p>
              <p><strong>领奖台次数：</strong>${s.podiums}</p>
              <p><strong>未完赛次数：</strong>${s.dnfs}</p>
              <canvas id="driverBarChart" height="300"></canvas>
            `;

            if(driverBarChart){driverBarChart.destroy();}

            driverBarChart=new Chart(document.getElementById('driverBarChart'),{
              type:'bar',
              data:{
                labels:raceLabelsShort,
                datasets:[{
                  label:'每场积分',
                  data:racePoints[driver],
                  backgroundColor:'#ff6f00'
                }]
              },
              options:{
                indexAxis:'y',
                responsive:true,
                plugins:{legend:{display:false}},
                scales:{x:{beginAtZero:true}}
              }
            });

            new bootstrap.Modal(document.getElementById('driverModal')).show();
          });
        });

        let datasets = sortedByPoints.map(item=>({
          label:item.driver,
          data:totalPoints[item.driver],
          borderWidth:2,
          fill:false
        }));

        new Chart(document.getElementById('trend'),{
          type:'line',
          data:{
            labels:raceLabels,
            datasets:datasets
          }
        });
      });
  </script>
</body>
</html>
